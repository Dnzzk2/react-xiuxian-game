# 代码结构优化建议

## 📋 概述

本文档提供了针对项目代码结构的优化建议，旨在提高代码的可维护性、可读性和开发效率。

## 🔍 发现的主要问题

### 1. 代码重复问题

#### 1.1 稀有度样式函数重复
**问题**：稀有度相关的样式函数在多个组件中重复定义：
- `getRarityColor` - 在 `EquipmentPanel.tsx`、`StatsPanel.tsx` 等组件中重复
- `getRarityBorder` - 在 `InventoryModal.tsx` 中定义
- `getRarityBadge` - 在 `InventoryModal.tsx` 中定义
- `getRarityNameClasses` - 在 `InventoryModal.tsx` 中定义

**影响**：
- 维护困难：修改样式需要在多个地方同步
- 代码冗余：增加了代码体积
- 不一致风险：不同组件可能使用不同的样式逻辑

#### 1.2 物品统计计算逻辑重复
**问题**：`getItemStats` 函数在多个地方重复实现：
- `utils/itemUtils.ts` - 标准实现
- `components/InventoryModal.tsx` - 内部重复实现（第125-152行）
- `components/InventoryModal.tsx` - 另一个实现（第609-639行）

**影响**：
- 逻辑不一致：不同地方的计算可能产生不同结果
- 维护成本高：修改计算逻辑需要同步多个地方

#### 1.3 装备槽位查找逻辑重复
**问题**：戒指、首饰、法宝的槽位查找逻辑在多个地方重复：
- `InventoryModal.tsx` - 多处重复（第167-206行，第294-325行，第676-697行）
- `EquipmentPanel.tsx` - 可能也有类似逻辑

**影响**：
- 代码冗余
- 维护困难

### 2. 项目结构问题

#### 2.1 features 和 views 目录功能重复
**问题**：
- `features/items/useItems.ts` 和 `views/items/useItemHandlers.ts` 功能重复
- `features/meditation/useMeditation.ts` 和 `views/meditation/useMeditationHandlers.ts` 可能也有重复

**影响**：
- 开发者困惑：不知道应该使用哪个
- 维护成本高：需要同时维护两套代码

#### 2.2 App.tsx 文件过大
**问题**：`App.tsx` 文件有 1282 行，包含：
- 大量状态管理
- 复杂的业务逻辑
- 多个 useEffect 钩子

**影响**：
- 可读性差
- 难以维护
- 难以测试

### 3. 工具函数组织问题

#### 3.1 缺少统一的样式工具函数库
**问题**：稀有度相关的样式函数分散在各个组件中，没有统一的工具库。

**建议**：创建 `utils/rarityUtils.ts` 统一管理所有稀有度相关的工具函数。

#### 3.2 装备相关工具函数分散
**问题**：装备槽位查找、装备状态检查等逻辑分散在多个文件中。

**建议**：创建 `utils/equipmentUtils.ts` 统一管理装备相关的工具函数。

## 🛠️ 优化方案

### 方案 1：创建统一的工具函数库

#### 1.1 创建 `utils/rarityUtils.ts`
统一管理所有稀有度相关的样式和工具函数。

**优势**：
- 消除重复代码
- 统一管理样式
- 易于维护和扩展

#### 1.2 创建 `utils/equipmentUtils.ts`
统一管理装备相关的工具函数。

**优势**：
- 集中管理装备逻辑
- 减少重复代码
- 提高代码复用性

### 方案 2：统一 features 和 views 目录

**建议**：
- 保留 `views/` 目录用于业务逻辑 handlers
- 将 `features/` 目录用于可复用的 hooks 和工具函数
- 明确两者的职责划分

**或者**：
- 合并两个目录，统一使用一个目录结构
- 根据功能模块组织，而不是根据类型组织

### 方案 3：拆分 App.tsx

**建议**：
- 将状态管理提取到自定义 hooks
- 将业务逻辑提取到 handlers
- 将 UI 渲染逻辑保留在 App.tsx 中

### 方案 4：创建常量配置文件

**建议**：
- 将装备槽位配置提取到常量文件
- 将稀有度配置集中管理
- 便于统一修改和维护

## 📝 具体实施步骤

### 第一步：创建工具函数库（优先级：高）

1. 创建 `utils/rarityUtils.ts` - 统一稀有度样式函数
2. 创建 `utils/equipmentUtils.ts` - 统一装备工具函数
3. 更新所有使用这些函数的组件

### 第二步：消除重复代码（优先级：高）

1. 统一使用 `utils/itemUtils.ts` 中的 `getItemStats`
2. 移除组件中重复的实现
3. 统一装备槽位查找逻辑

### 第三步：优化项目结构（优先级：中）

1. 明确 features 和 views 的职责
2. 合并或重构重复的功能模块
3. 拆分 App.tsx 文件

### 第四步：代码质量提升（优先级：低）

1. 添加 TypeScript 类型定义
2. 添加单元测试
3. 优化性能（使用 useMemo、useCallback 等）

## 🎯 预期收益

### 开发效率提升
- **减少代码重复**：减少 30-40% 的重复代码
- **统一工具函数**：新功能开发时可以直接使用工具函数
- **清晰的目录结构**：新开发者更容易理解项目结构

### 代码质量提升
- **可维护性**：修改样式或逻辑只需要在一个地方修改
- **一致性**：所有组件使用相同的样式和逻辑
- **可测试性**：工具函数更容易进行单元测试

### 性能优化
- **减少包体积**：消除重复代码可以减小打包体积
- **更好的缓存**：统一的工具函数更容易被浏览器缓存

## 📌 注意事项

1. **向后兼容**：重构时确保不破坏现有功能
2. **渐进式重构**：可以分阶段进行，不需要一次性完成
3. **测试覆盖**：重构后需要充分测试，确保功能正常
4. **文档更新**：重构后需要更新相关文档

## 🔄 后续优化方向

1. **组件拆分**：将大型组件拆分为更小的可复用组件
2. **状态管理优化**：考虑使用状态管理库（如 Zustand、Jotai）
3. **性能优化**：使用 React.memo、useMemo 等优化渲染性能
4. **类型安全**：加强 TypeScript 类型定义，减少 any 的使用

